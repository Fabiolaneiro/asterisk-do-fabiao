; ======================================================
; RUA - LOGIN/LOGOUT DE AGENTES NA FILA
; - O agente disca no próprio softphone:
;   *99 = login na fila rua
;   #99 = logout da fila rua
;   *953 = status (mostra no CLI)
; ======================================================

[rua-agent-codes]
exten => *99,1,NoOp(RUA LOGIN | ramal=${CALLERID(num)})
 same => n,Set(AGENT=${CALLERID(num)})
 same => n,GotoIf($["${AGENT}"=""]?bad,1)

 ; adiciona como LOCAL, para podermos controlar o "não atendeu"
 same => n,Set(IFACE=Local/${AGENT}@rua-member-dial/n)
 same => n,NoOp(ADD em rua: ${IFACE})
 ; pega contador global e incrementa (FIFO)
 same => n,Set(N=${DB(rua/seq)})
 same => n,Set(N=${IF($["${N}"=""]?0:${N})})
 same => n,Set(N=$[${N}+1])
 same => n,Set(DB(rua/seq)=${N})

 ; remove e adiciona com penalty = N
 same => n,RemoveQueueMember(rua,${IFACE})
 same => n,AddQueueMember(rua,${IFACE},${N})
 same => n,Playback(beep)
 same => n,Hangup()

exten => bad,1,Playback(invalid)
 same => n,Hangup()


; Logout manual (se você tiver um código tipo *98 ou #99, use aqui)
exten => #99,1,NoOp(RUA LOGOUT | ramal=${CALLERID(num)})
 same => n,Set(AGENT=${CALLERID(num)})
 same => n,Set(IFACE=Local/${AGENT}@rua-member-dial/n)
 same => n,RemoveQueueMember(rua,${IFACE})
 same => n,Playback(beep)
 same => n,Hangup()

exten => *953,1,NoOp(RUA STATUS)
 same => n,NoOp(RUA DB LOGADOS: ${DB(rua/logado)})
 same => n,Playback(beep)
 same => n,Hangup()

exten => bad,1,NoOp(RUA CODIGO INVALIDO | callerid=${CALLERID(num)})
 same => n,Playback(invalid)
 same => n,Hangup()


; ======================================================
; RUA - MEMBER HANDLER
; É chamado pela fila para cada membro discado.
; Variáveis úteis que a fila seta:
; - ${MEMBERINTERFACE}  ex: PJSIP/31
; - ${MEMBERNAME}       (se você configurou nome do membro)
; - ${QUEUESTATUS} / ${DIALSTATUS} (dependendo da versão/fluxo)
;
; Regra:
; - Se o membro atendeu -> remove da fila
; - Se não atendeu (NOANSWER/BUSY/CHANUNAVAIL/CONGESTION) -> remove da fila
; ======================================================

[rua-member-handler]
exten => s,1,NoOp(RUA MEMBER HANDLER | iface=${MEMBERINTERFACE} | dialstatus=${DIALSTATUS} | queuestatus=${QUEUESTATUS})

 ; Segurança: se por algum motivo não veio interface, sai
 same => n,GotoIf($["${MEMBERINTERFACE}"=""]?done)

 ; Remove SEMPRE após a tentativa (atendeu ou não)
 ; Isso garante: "tocou pra ele uma vez, sai da fila"
 same => n,RemoveQueueMember(rua,${MEMBERINTERFACE})

 same => n,NoOp(RUA REMOVIDO DA FILA | iface=${MEMBERINTERFACE})
 same => n(done),Return()


; ======================================================
; Cada membro da fila rua toca via Local/<ramal>@rua-member-dial/n
; Aqui nós:
; - Dial(PJSIP/<ramal>,30)
; - depois do Dial terminar (ANSWER ou NOANSWER), removemos o membro da fila
; ======================================================

[rua-member-dial]
exten => _X.,1,NoOp(RUA MEMBER DIAL | ramal=${EXTEN} | uniqueid=${UNIQUEID})
 same => n,Set(AGENT=${EXTEN})
 same => n,Set(IFACE=Local/${AGENT}@rua-member-dial/n)

 ; remove da fila ANTES de discar (garante auto-deslog em qualquer cenário)
 same => n,NoOp(REMOVENDO ANTES DE TOCAR: ${IFACE})
 same => n,RemoveQueueMember(rua,${IFACE})

 ; agora toca no agente
 same => n,Dial(PJSIP/${AGENT},30)

 same => n,Hangup()
