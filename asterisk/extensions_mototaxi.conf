; ============================================================
; MOTOTAXI - FILAS "NA MÃO" (SEM Queue() e SEM Local/)
; - MESA: login feito nos ramais 5500/5600/6100 discando *2X (ex: *22)
; - MOTOTAXI: login feito no softphone do agente discando *2X (ex: *22)
; - Ordem por login (fila FIFO em AstDB)
; - Timeout 6s: se não atende -> logout-all (sai das duas listas)
; - Se atende em qualquer lista -> cria corrida + logout-all
; ============================================================

[globals]
RIDE_TTL=3600
RING_TIMEOUT=6

; ==========================
; Tronco (Twilio) -> MAIN
; ==========================
[incoming]
exten => s,1,Goto(main,500,1)
exten => _X.,1,Goto(main,500,1)
exten => _+55X.,1,Goto(main,500,1)

; ==========================
; Chamadas internas
; ==========================
[from-internal]
include => internal
include => login
include => ride-codes

[internal]
exten => 5500,1,Dial(PJSIP/5500,20)  same => n,Hangup()
exten => 5600,1,Dial(PJSIP/5600,20)  same => n,Hangup()
exten => 6100,1,Dial(PJSIP/6100,20)  same => n,Hangup()
exten => _2X,1,Dial(PJSIP/${EXTEN},20) same => n,Hangup()

; ==========================
; LOGIN / LOGOUT
; *2X  -> login (mesa OU mototaxi dependendo de quem discou)
; *00XX -> logout manual do agente XX (de tudo)
; ==========================
[login]
exten => _*2X,1,NoOp(LOGIN *2X callerid=${CALLERID(num)} endpoint=${PJSIP_ENDPOINT} code=${EXTEN})
 same => n,Set(AGENT=${EXTEN:1})

 ; se discou a partir de uma MESA (5500/5600/6100) -> login na lista MESA
 same => n,GotoIf($[${REGEX("^(5500|5600|6100)$" ${CALLERID(num)})}]?mesa:mototaxi)

 same => n(mesa),Gosub(login-mesa,s,1(${AGENT},${CALLERID(num)}))
 same => n,Hangup()

 same => n(mototaxi),Gosub(login-mototaxi,s,1(${AGENT}))
 same => n,Hangup()

exten => _*00XX,1,NoOp(LOGOUT MANUAL agent=${EXTEN:3})
 same => n,Gosub(logout-all,s,1(${EXTEN:3}))
 same => n,Playback(agent-loggedoff)
 same => n,Hangup()

; ==========================
; MAIN (entrada do DID)
; - se corrida ativa -> vai direto pro agente
; - senão tenta MESA (FIFO, 6s cada)
; - se ninguém atende -> tenta MOTOTAXI (FIFO, 6s cada)
; ==========================
[main]
exten => 500,1,NoOp(INBOUND caller=${CALLERID(num)})
 same => n,Set(CLIENT=${CALLERID(num)})

 ; corrida ativa?
 same => n,Set(RIDE_AGENT=${DB(ride/${CLIENT}/agent)})
 same => n,Set(RIDE_START=${DB(ride/${CLIENT}/start)})
 same => n,GotoIf($["${RIDE_AGENT}"=""]?trymesa:checkttl)

 same => n(checkttl),Set(NOW=${EPOCH})
 same => n,GotoIf($[${NOW}-${RIDE_START}<=${RIDE_TTL}]?toagent:expire)

 same => n(expire),NoOp(RIDE EXPIRED cleanup client=${CLIENT})
 same => n,DBdel(ride/${CLIENT}/agent)
 same => n,DBdel(ride/${CLIENT}/start)
 same => n,DBdel(ride/${CLIENT}/rec)
 same => n,Goto(trymesa)

 same => n(toagent),NoOp(ROUTE BACK TO AGENT ${RIDE_AGENT})
 same => n,Answer()
 same => n,Dial(PJSIP/${RIDE_AGENT},20)
 same => n,Hangup()

 same => n(trymesa),Answer()
 same => n,Gosub(try-list,s,1(mesa,${CLIENT}))
 same => n,GotoIf($["${GOSUB_RETVAL}"="ANSWER"]?done:trymoto)

 same => n(trymoto),Gosub(try-list,s,1(mototaxi,${CLIENT}))
 same => n(done),Hangup()

; ============================================================
; login-mesa(agent,mesaExt)
; - salva mapping agent->mesa
; - entra na lista FIFO mesa
; ============================================================
[login-mesa]
exten => s,1,NoOp(LOGIN-MESA agent=${ARG1} mesa=${ARG2})
 same => n,Gosub(check-not-in-ride,s,1(${ARG1}))  ; bloqueia se em corrida

 ; evita duplicar login (remove antes e reinsere no final)
 same => n,Gosub(list-remove,s,1(mesa,${ARG1}))
 same => n,Gosub(list-remove,s,1(mototaxi,${ARG1})) ; opcional: se quer que relogar na mesa "resete" tudo, tira isso

 same => n,Set(DB(mesa/map/${ARG1})=${ARG2})
 same => n,Gosub(list-add,s,1(mesa,${ARG1}))
 same => n,Playback(agent-loginok)
 same => n,Return()

; ============================================================
; login-mototaxi(agent)
; - entra na lista FIFO mototaxi
; ============================================================
[login-mototaxi]
exten => s,1,NoOp(LOGIN-MOTOTAXI agent=${ARG1} endpoint=${PJSIP_ENDPOINT})
 ; valida: só 20-29 (ajuste se precisar)
 same => n,GotoIf($[${REGEX("^2[0-9]$" ${ARG1})}]?ok:bad)
 same => n(bad),Playback(pm-invalid-option)
 same => n,Return()
 same => n(ok),Gosub(check-not-in-ride,s,1(${ARG1}))

 ; evita duplicar login
 same => n,Gosub(list-remove,s,1(mototaxi,${ARG1}))
 same => n,Gosub(list-add,s,1(mototaxi,${ARG1}))
 same => n,Playback(agent-loginok)
 same => n,Return()

; ============================================================
; check-not-in-ride(agent)
; ============================================================
[check-not-in-ride]
exten => s,1,Set(INRIDE=${DB(agentride/${ARG1}/client)})
 same => n,GotoIf($["${INRIDE}"=""]?ok:deny)
 same => n(deny),Playback(vm-incorrect)
 same => n,Return()
 same => n(ok),Return()

; ============================================================
; try-list(listname, client)
; - tenta a lista FIFO: pega o primeiro, toca 6s
; - se não atende: logout-all e tenta próximo
; - se atende: cria corrida + logout-all e retorna ANSWER
; Retorna em GOSUB_RETVAL: ANSWER | FAIL
; ============================================================
[try-list]
exten => s,1,NoOp(TRY-LIST list=${ARG1} client=${ARG2})
 same => n,Set(LIST=${ARG1})
 same => n,Set(CLIENT=${ARG2})
 same => n,Set(RES=FAIL)

 same => n(LOOP),Gosub(list-pop,s,1(${LIST}))
 same => n,Set(AGENT=${GOSUB_RETVAL})
 same => n,GotoIf($["${AGENT}"=""]?END:DO)

 same => n(DO),NoOp(Trying agent=${AGENT} from ${LIST})

 ; destino: se LIST=mesa toca a MESA mapeada; se mototaxi toca o PJSIP/<agent>
 same => n,GotoIf($["${LIST}"="mesa"]?TOMESA:TOMOTO)

 same => n(TOMESA),Set(MESAEXT=${DB(mesa/map/${AGENT})})
 same => n,GotoIf($["${MESAEXT}"=""]?MISSED:CALLMESA)
 same => n(CALLMESA),NoOp(Dial MESA ${MESAEXT} for agent ${AGENT})
 same => n,Dial(PJSIP/${MESAEXT},${RING_TIMEOUT},U(ride-answer^s^1(${AGENT},${CLIENT})))
 same => n,Goto(POSTDIAL)

 same => n(TOMOTO),NoOp(Dial MOTO ${AGENT})
 same => n,Dial(PJSIP/${AGENT},${RING_TIMEOUT},U(ride-answer^s^1(${AGENT},${CLIENT})))
 same => n,Goto(POSTDIAL)

 same => n(POSTDIAL),NoOp(DIALSTATUS=${DIALSTATUS})
 same => n,GotoIf($["${DIALSTATUS}"="ANSWER"]?ANSWERED:MISSED)

 same => n(MISSED),NoOp(MISSED -> logout-all agent=${AGENT})
 same => n,Gosub(logout-all,s,1(${AGENT}))
 same => n,Goto(LOOP)

 same => n(ANSWERED),Set(RES=ANSWER)
 same => n(END),Set(GOSUB_RETVAL=${RES})
 same => n,Return()

; ============================================================
; ride-answer(agent, client)  (executa NO CANAL QUE ATENDEU)
; - cria ride + grava
; - logout-all do agente
; ============================================================
[ride-answer]
exten => s,1,NoOp(RIDE-ANSWER agent=${ARG1} client=${ARG2})
 same => n,Gosub(create-ride,s,1(${ARG2},${ARG1}))
 same => n,Gosub(logout-all,s,1(${ARG1}))
 same => n,Return()

; ============================================================
; create-ride(client, agent)
; ============================================================
[create-ride]
exten => s,1,NoOp(CREATE-RIDE client=${ARG1} agent=${ARG2})
 same => n,Set(CLIENT=${ARG1})
 same => n,Set(AGENT=${ARG2})
 same => n,Set(NOW=${EPOCH})

 same => n,Set(RECFILE=ride-${CLIENT}-${AGENT}-${STRFTIME(${NOW},,%Y%m%d-%H%M%S)}.wav)
 same => n,MixMonitor(${RECFILE},a)

 same => n,Set(DB(ride/${CLIENT}/agent)=${AGENT})
 same => n,Set(DB(ride/${CLIENT}/start)=${NOW})
 same => n,Set(DB(ride/${CLIENT}/rec)=${RECFILE})

 same => n,Set(DB(agentride/${AGENT}/client)=${CLIENT})
 same => n,Set(DB(agentride/${AGENT}/start)=${NOW})
 same => n,Return()

; ============================================================
; logout-all(agent)
; - remove das duas listas
; - limpa map mesa e estado agentride
; ============================================================
[logout-all]
exten => s,1,NoOp(LOGOUT-ALL agent=${ARG1})
 same => n,Gosub(list-remove,s,1(mesa,${ARG1}))
 same => n,Gosub(list-remove,s,1(mototaxi,${ARG1}))
 same => n,DBdel(mesa/map/${ARG1})
 ; NÃO apaga ride do cliente aqui, só apaga “agentride do agente”
 same => n,DBdel(agentride/${ARG1}/client)
 same => n,DBdel(agentride/${ARG1}/start)
 same => n,Return()

; ============================================================
; LISTAS FIFO em AstDB
; Estrutura:
;  /list/<name>/head
;  /list/<name>/tail
;  /list/<name>/item/<idx> = agent
; ============================================================

[list-add]
exten => s,1,Set(L=${ARG1})
 same => n,Set(A=${ARG2})
 same => n,Set(T=${IF($["${DB(list/${L}/tail)}"=""]?0:${DB(list/${L}/tail)})})
 same => n,Set(T=$[${T}+1])
 same => n,Set(DB(list/${L}/tail)=${T})
 same => n,ExecIf($["${DB(list/${L}/head)}"=""]?Set(DB(list/${L}/head)=1))
 same => n,Set(DB(list/${L}/item/${T})=${A})
 same => n,Return()

[list-pop]
exten => s,1,Set(L=${ARG1})
 same => n,Set(H=${IF($["${DB(list/${L}/head)}"=""]?0:${DB(list/${L}/head)})})
 same => n,Set(T=${IF($["${DB(list/${L}/tail)}"=""]?0:${DB(list/${L}/tail)})})
 same => n,GotoIf($[${H}<=0 | ${H}>${T}]?EMPTY:SCAN)

 same => n(SCAN),Set(AG=)
 same => n,While($[${H}<=${T}])
 same => n,Set(AG=${DB(list/${L}/item/${H})})
 same => n,ExecIf($["${AG}"!=""]?Break())
 same => n,Set(H=$[${H}+1])
 same => n,EndWhile()

 same => n,GotoIf($["${AG}"=""]?EMPTY:OK)

 same => n(OK),DBdel(list/${L}/item/${H})
 same => n,Set(H=$[${H}+1])
 same => n,Set(DB(list/${L}/head)=${H})
 same => n,Set(GOSUB_RETVAL=${AG})
 same => n,Return()

 same => n(EMPTY),Set(GOSUB_RETVAL=)
 same => n,Return()

[list-remove]
exten => s,1,Set(L=${ARG1})
 same => n,Set(A=${ARG2})
 same => n,Set(H=${IF($["${DB(list/${L}/head)}"=""]?0:${DB(list/${L}/head)})})
 same => n,Set(T=${IF($["${DB(list/${L}/tail)}"=""]?0:${DB(list/${L}/tail)})})
 same => n,While($[${H}>0 & ${H}<=${T}])
 same => n,Set(CUR=${DB(list/${L}/item/${H})})
 same => n,ExecIf($["${CUR}"="${A}"]?DBdel(list/${L}/item/${H}))
 same => n,Set(H=$[${H}+1])
 same => n,EndWhile()
 same => n,Return()

; ============================================================
; Códigos de corrida
; *99 -> agente liga pro cliente atual
; *98XX -> encerra corrida do agente XX
; ============================================================
[ride-codes]
exten => *99,1,NoOp(CALL CLIENT agent=${PJSIP_ENDPOINT})
 same => n,Set(AGENT=${PJSIP_ENDPOINT})
 same => n,Set(CLIENT=${DB(agentride/${AGENT}/client)})
 same => n,GotoIf($["${CLIENT}"!=""]?call:bad)
 same => n(call),Dial(PJSIP/${CLIENT},20)
 same => n,Hangup()
 same => n(bad),Playback(pm-invalid-option)
 same => n,Hangup()

exten => _*98XX,1,NoOp(END RIDE agent=${EXTEN:3})
 same => n,Set(AGENT=${EXTEN:3})
 same => n,Set(CLIENT=${DB(agentride/${AGENT}/client)})
 same => n,GotoIf($["${CLIENT}"!=""]?do:done)

 same => n(do),DBdel(agentride/${AGENT}/client)
 same => n,DBdel(agentride/${AGENT}/start)
 same => n,DBdel(ride/${CLIENT}/agent)
 same => n,DBdel(ride/${CLIENT}/start)
 same => n,DBdel(ride/${CLIENT}/rec)

 same => n(done),Playback(agent-loggedoff)
 same => n,Hangup()
