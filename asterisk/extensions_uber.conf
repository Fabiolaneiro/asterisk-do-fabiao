[general]
static=yes
writeprotect=no
clearglobalvars=no


; ==================================================
; CONTEXTO PRINCIPAL - RAMAIS INTERNOS
; ==================================================
[from-internal]

; ---------- CHAMADAS ENTRE RAMAIS ----------
exten => _7XXX,1,NoOp(Chamada direta para ramal ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN},20)
 same => n,Hangup()

; ---------- ACESSO Ã€ FILA ----------
exten => 700,1,Goto(fila-uber,s,1)



; ==================================================
; CONTEXTO DA FILA
; ==================================================
[fila-uber]
exten => s,1,NoOp(Entrada na fila uber)
 same => n,Answer()
; same => n,Set(__AUDIOHOOK_INHERIT(MixMonitor)=yes)
; same => n,Set(__RECFILE=${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}_${CALLERID(num)}_600)
; same => n,Set(CDR(userfield)=${RECFILE}.wav)
; same => n,MixMonitor(${RECFILE}.wav,b)
 same => n,Gosub(uber-vez,s,1)
; same => n,Queue(uber,t)
 same => n,Hangup()

; ==================================================
; CONTEXTO PARA CHAMADAS EXTERNAS (SEGURANÃ‡A)
; Tudo que vier da internet / IP desconhecido NÃƒO pode cair em from-internal
; ==================================================
[from-external]
exten => _X.,1,NoOp(BLOCKED EXTERNAL INVITE: src=${CHANNEL(recvip)}:${CHANNEL(recvport)} from=${CALLERID(all)} to=${EXTEN})
 same => n,Hangup(603)

[from-twilio]
exten => _+X.,1,NoOp(ğŸ“ Twilio inbound DID=${EXTEN} CID=${CALLERID(num)})
 same => n,Goto(fila-uber,s,1)

exten => _X.,1,NoOp(ğŸ“ Twilio inbound DID=${EXTEN} CID=${CALLERID(num)})
 same => n,Goto(fila-uber,s,1)


[outbound-twilio]
; Discagem em E.164: 00 + paÃ­s + DDD + nÃºmero (ex: 0055...)
exten => _+X.,1,NoOp(Saida via Twilio (E164): ${EXTEN})
 same => n,Set(NUM=${EXTEN})
 same => n,Dial(PJSIP/${NUM}@twilio-endpoint,60)
 same => n,Hangup()
exten => _00X.,1,NoOp(Saida via Twilio: ${EXTEN})
 same => n,Set(NUM=+${EXTEN:2})
 same => n,Dial(PJSIP/${NUM}@twilio-endpoint,60)
 same => n,Hangup()

; Discagem BR sem o + (ex: 55DDDNUMERO)
exten => _55X.,1,NoOp(Saida via Twilio: ${EXTEN})
 same => n,Set(NUM=+${EXTEN})
 same => n,Dial(PJSIP/${NUM}@twilio-endpoint,60)
 same => n,Hangup()
