; ============================================================
; TAXI - VARAL DIGITAL (PASSO 1)
; Objetivo do passo 1:
; - Motorista faz "login" no varal digitando *41, *43 etc (no ramal 40)
; - Asterisk guarda uma lista FIFO no AstDB: DB(taxi/line)
; - Ter um código de status para checar a lista no CLI
; ============================================================

; ------------------------------------------------------------
; Contexto do telefone da base (ramal 40)
; Importante: o endpoint 40 aponta context=taxi-base
; ------------------------------------------------------------




; ------------------------------------------------------------
; SUBROTINA: adiciona agente no fim da lista FIFO (sem duplicar)
; Guarda em DB(taxi/line) no formato: 41|42|43
; ARG1 = agente (ex: 41)
; ------------------------------------------------------------
[taxi-varal-add]
exten => s,1,NoOp(TAXI LINE ADD | AGENTE=${ARG1})
 same => n,Set(AGENTE=${ARG1})
 same => n,Set(LISTA=${DB(taxi/line)})

 ; Se já existe, não adiciona
 same => n,Set(EXISTE=${REGEX("(^|\\|)${AGENTE}(\\||$)" ${LISTA})})
 same => n,GotoIf($[${EXISTE}=1]?done)

 ; Se lista vazia, vira só o agente
 same => n,GotoIf($["${LISTA}"=""]?first)

 ; Senão concatena no final
 same => n,Set(LISTA=${LISTA}|${AGENTE})
 same => n,Set(DB(taxi/line)=${LISTA})
 same => n,Goto(done)

 same => n(first),Set(DB(taxi/line)=${AGENTE})
 same => n(done),NoOp(NOVA LISTA = ${DB(taxi/line)})
 same => n,Return()



[taxi-varal-remove]
exten => s,1,NoOp(TAXI LINE REMOVE | ARG1='${ARG1}')
 same => n,Set(AGENTE=${ARG1})

 ; segurança: se vier vazio, NÃO mexe na fila
 same => n,GotoIf($["${AGENTE}"=""]?done)

 ; normaliza: mantém só números (evita \r, espaços, etc)
 same => n,Set(AGENTE=${FILTER(0-9,${AGENTE})})
 same => n,GotoIf($["${AGENTE}"=""]?done)

 same => n,Set(LISTA=${DB(taxi/line)})
 same => n,NoOp(ANTES | LISTA='${LISTA}' | AGENTE='${AGENTE}')

 ; se lista vazia, nada a fazer
 same => n,GotoIf($["${LISTA}"=""]?done)

 ; reconstrói a lista removendo apenas o AGENTE
 same => n,Set(NOVA=)
 same => n,Set(CNT=${FIELDQTY(LISTA,|)})
 same => n,Set(I=1)

 same => n,While($[${I}<=${CNT}])
  same => n,Set(ITEM=${CUT(LISTA,|,${I})})
  same => n,Set(ITEM=${FILTER(0-9,${ITEM})})
  same => n,ExecIf($["${ITEM}"="" ]?Set(I=$[${I}+1])&Continue())
  same => n,ExecIf($["${ITEM}"="${AGENTE}"]?NoOp(REMOVENDO ITEM=${ITEM}):ExecIf($["${NOVA}"=""]?Set(NOVA=${ITEM}):Set(NOVA=${NOVA}|${ITEM})))
  same => n,Set(I=$[${I}+1])
 same => n,EndWhile()

 same => n,Set(DB(taxi/line)=${NOVA})
 same => n,NoOp(DEPOIS | DB(taxi/line)='${DB(taxi/line)}')

 same => n(done),Return()


[taxi-base]

exten => *940,1,NoOp(TAXI STATUS)
 same => n,Gosub(taxi-status,s,1)
 same => n,Playback(beep)
 same => n,Hangup()

; ==============================
; LOGIN: *<numero>
; ==============================
exten => _*X.,1,NoOp(TAXI LOGIN | Discado=${EXTEN} | Base=${CALLERID(num)})
 same => n,Set(AGENTE=${EXTEN:1})
 same => n,Set(BASELOGIN=${CALLERID(num)})

 same => n,Set(AGENTNAME=${DB(taxi/nome/${AGENTE})})
 same => n,GotoIf($["${AGENTNAME}"=""]?nao_cadastrado)

 same => n,Set(DB(taxi/present_ts/${AGENTE})=${EPOCH})
 same => n,Set(DB(taxi/present_base/${AGENTE})=${BASELOGIN})

 ; >>> ENTRA NA FILA FIFO (taxi/line)
 same => n,Gosub(taxi-varal-add,s,1(${AGENTE}))

 ; webhook (como você já usa)
 same => n,Gosub(taxivaral-webhook-send,s,1(login,${AGENTE},,,${BASELOGIN}))

 same => n,Playback(beep)
 same => n,Hangup()

exten => nao_cadastrado,1,NoOp(AGENTE NAO CADASTRADO: ${AGENTE})
 same => n,Playback(invalid)
 same => n,Hangup()

; ==============================
; LOGOUT: #<numero>
; ==============================
exten => _#X.,1,NoOp(TAXI LOGOUT | Discado=${EXTEN} | Base=${CALLERID(num)})
 same => n,Set(AGENTE=${EXTEN:1})

 ; precisa pegar o nome antes de validar
 same => n,Set(AGENTNAME=${DB(taxi/nome/${AGENTE})})
 same => n,GotoIf($["${AGENTNAME}"=""]?nao_cadastrado)

 same => n,DBDeltree(taxi/present_ts/${AGENTE})
 same => n,DBDeltree(taxi/present_base/${AGENTE})

 ; >>> SAI DA FILA FIFO (taxi/line)
 same => n,Gosub(taxi-varal-remove,s,1(${AGENTE}))

 ; webhook opcional (se quiser manter)
 same => n,Gosub(taxivaral-webhook-send,s,1(logout,${AGENTE},,,${CALLERID(num)}))

 same => n,Playback(beep)
 same => n,Hangup()

[taxi-status]
exten => s,1,NoOp(--- TAXI STATUS ---)
 same => n,Set(T41=${DB(taxi/present_ts/41)})
 same => n,Set(T42=${DB(taxi/present_ts/42)})
 same => n,Set(T43=${DB(taxi/present_ts/43)})
 same => n,NoOp(PRESENTES: 41=${T41} | 42=${T42} | 43=${T43})
 same => n,Gosub(taxi-pick,s,1)
 same => n,Set(BASEPICK=${DB(taxi/present_base/${PICK})})
 same => n,NoOp(DA VEZ = ${PICK} | TS=${PICKTS} | BASE=${BASEPICK})
 same => n,Return()

[taxi-pick]
exten => s,1,NoOp(TAXI PICK START)
 same => n,Set(PICK=)
 same => n,Set(PICKTS=)
 same => n,Set(PICKBASE=)

 ; lê a fila FIFO
 same => n,Set(LISTA=${DB(taxi/line)})
 same => n,NoOp(TAXI PICK | LISTA='${LISTA}')

 ; se vazio, retorna vazio
 same => n,GotoIf($["${LISTA}"=""]?done)

 ; pega o 1º da lista (antes do primeiro |)
 same => n,Set(PICK=${CUT(LISTA,|,1)})

 ; busca dados do agente
 same => n,Set(PICKTS=${DB(taxi/present_ts/${PICK})})
 same => n,Set(PICKBASE=${DB(taxi/present_base/${PICK})})

 same => n,NoOp(TAXI PICK RESULT | PICK=${PICK} TS=${PICKTS} BASE=${PICKBASE})

 same => n(done),Return()




; ============================================================
; PASSO 2 - INBOUND DO TAXI (VARAL DIGITAL)
; ============================================================

;[taxi-inbound]
;exten => s,1,Gosub(taxi-varal-call,s,1)
; same => n,Hangup()

;exten => _X.,1,Gosub(taxi-varal-call,s,1)
; same => n,Hangup()

;exten => _+X.,1,Gosub(taxi-varal-call,s,1)
; same => n,Hangup()
[taxi-inbound]
exten => s,1,NoOp(INBOUND | CID=${CALLERID(num)} DID=${EXTEN})

 ; =========================
 ; RECONEXAO DO CLIENTE
 ; =========================
 same => n,Set(MOTORISTA=${DB(taxi/corrida/cliente/${CALLERID(num)})})
 same => n,GotoIf($["${MOTORISTA}"!=""]?reconecta)

 ; =========================
 ; NOVA CHAMADA (FLUXO NORMAL)
 ; =========================
 same => n,Gosub(taxi-varal-call,s,1)
 same => n,Hangup()

 same => n(reconecta),NoOp(RECONEXAO CLIENTE -> MOTORISTA ${MOTORISTA})
 same => n,Dial(PJSIP/${MOTORISTA},30)
 same => n,Hangup()


exten => _X.,1,Gosub(taxi-inbound,s,1)
exten => _+X.,1,Gosub(taxi-inbound,s,1)


; ============================================================
; SUBROTINA PRINCIPAL: chama ramal 40 usando a vez
; ============================================================
[taxi-varal-call-errado]
exten => s,1,NoOp(TAXI VARAL CALL START | CID=${CALLERID(num)} DID=${EXTEN})

 ; escolhe o motorista da vez (mais antigo)
 same => n,Gosub(taxi-pick,s,1)
 same => n,NoOp(DA VEZ=${PICK} TS=${PICKTS})

 ; se ninguém logado -> fallback
 same => n,GotoIf($["${PICK}"=""]?fallback)

 ; remove da vez ANTES de tocar (regra: atendeu ou não, sai)
 ; (mantém exatamente sua regra)
 same => n,DBDeltree(taxi/present_ts/${PICK})

 ; toca o telefone da base por 30s
 same => n,NoOp(TOCANDO BASE 40 POR 30s | motorista_da_vez=${PICK})
 same => n,Dial(PJSIP/40,30)

 ; se atendeu, terminou (cliente falou com a base; já removemos o motorista)
 same => n,GotoIf($["${DIALSTATUS}"="ANSWER"]?done)

 ; não atendeu -> tenta próximo
 same => n,NoOp(NAO ATENDEU (${DIALSTATUS}) -> PROXIMO)
 same => n,Goto(s,2)

 same => n(fallback),NoOp(SEM MOTORISTAS LOGADOS -> FALLBACK FILA TAXI)
 same => n,Queue(rua,t)      ; <- você cria/usa uma fila "taxi" geral
 same => n,Return()

 same => n(done),NoOp(ATENDIDA NA BASE | motorista=${PICK})
 same => n,Return()

; ======================================================
; TAXI VARAL CALL (GLOBAL, 2 BASES)
; Regras:
; - Vez é global (41/42/43 entram na mesma "fila" de vez)
; - Motorista loga na base 40 OU 50
;   DB(taxi/present_ts/<AGENTE>)   = EPOCH
;   DB(taxi/present_base/<AGENTE>) = 40 ou 50
; - Chegou chamada: escolhe o mais antigo (taxi-pick)
; - Toca APENAS na base onde ele está (40 ou 50) por 30s
; - Atendeu: webhook "atendeu" (via U(taxi-onanswer...))
; - Não atendeu: webhook "removido", perde a vez e tenta próximo
; - Se ninguém estiver na vez: fallback para fila uber
; ======================================================

[taxi-varal-call]
exten => s,1,NoOp(TAXI VARAL CALL START | CID=${CALLERID(num)} DID=${EXTEN})
 same => n,Answer()
 same => n,Ringing()

 ; loop: tenta atender o próximo da lista
 same => n(loop),Gosub(taxi-pick,s,1)
 same => n,NoOp(DA VEZ PICK='${PICK}' BASE='${PICKBASE}' TS='${PICKTS}')

 ; se ninguém logado -> fallback
 same => n,GotoIf($["${PICK}"=""]?fallback)

 ; se por algum motivo não achou base -> remove esse cara (pra não travar) e tenta próximo
 same => n,GotoIf($["${PICKBASE}"=""]?badpick)

 ; =========================
 ; POP (remove 1 ANTES de tocar)
 ; =========================
 same => n,NoOp(POP: removendo ${PICK} da taxi/line e limpando presença)
 same => n,Gosub(taxi-varal-remove,s,1(${PICK}))
 same => n,DBDeltree(taxi/present_ts/${PICK})
 same => n,DBDeltree(taxi/present_base/${PICK})

 ; tocar na base do agente
 same => n,NoOp(TOCANDO BASE ${PICKBASE} POR 30s | motorista=${PICK})
 ;same => n,Dial(PJSIP/${PICKBASE},30,U(taxi-onanswer^s^1(${PICK},${CALLERID(num)},${PICKBASE})))
;trocado agora 16:38
same => n,Dial(PJSIP/${PICKBASE},30,U(taxi-onanswer^${PICK}^${CALLERID(num)}^${PICKBASE}))

 ; atendeu?
 same => n,GotoIf($["${DIALSTATUS}"="ANSWER"]?done)

 ; não atendeu -> webhook removido e tenta o próximo
 same => n,NoOp(NAO ATENDEU (${DIALSTATUS}) -> PROXIMO)
 same => n,Gosub(taxivaral-webhook-send,s,1(removido,${PICK},,${DIALSTATUS},${PICKBASE}))
 same => n,Goto(loop)

 ; se PICK veio estranho (sem base), remove o cara e segue
 same => n(badpick),NoOp(BADPICK: PICK=${PICK} sem base -> removendo e seguindo)
 same => n,Gosub(taxi-varal-remove,s,1(${PICK}))
 same => n,DBDeltree(taxi/present_ts/${PICK})
 same => n,DBDeltree(taxi/present_base/${PICK})
 same => n,Goto(loop)

 same => n(fallback),NoOp(SEM MOTORISTAS LOGADOS -> FALLBACK FILA RUA)
 same => n,Queue(rua,t)
 same => n,Return()

 same => n(done),NoOp(FIM taxi-varal-call)
 same => n,Return()

[taxi-onanswer]
exten => s,1,NoOp(ONANSWER | AGENTE=${ARG1} CLIENTE=${ARG2} BASE=${ARG3})

 ; ===== NORMALIZA =====
 same => n,Set(AGENTE=${ARG1})
 same => n,Set(CLIENTE=${ARG2})
 same => n,Set(BASE=${ARG3})

 ; ===== VALIDAÇÃO =====
 same => n,GotoIf($["${AGENTE}"="" || "${CLIENTE}"=""]?skip_corrida)

 ; ===== LIMPA CORRIDA ANTIGA =====
 same => n,Set(CLI_OLD=${DB(taxi/corrida/ativa/${AGENTE})})
 same => n,ExecIf($["${CLI_OLD}"!=""]?Set(DB_DELETE(taxi/corrida/cliente/${CLI_OLD})=1))
 same => n,Set(DB_DELETE(taxi/corrida/ativa/${AGENTE})=1)
 same => n,Set(DB_DELETE(taxi/corrida/ts/${AGENTE})=1)
 same => n,Set(DB_DELETE(taxi/corrida/base/${AGENTE})=1)

 ; ===== GRAVA NOVA CORRIDA =====
 same => n,Set(DB(taxi/corrida/ativa/${AGENTE})=${CLIENTE})
 same => n,Set(DB(taxi/corrida/cliente/${CLIENTE})=${AGENTE})
 same => n,Set(DB(taxi/corrida/ts/${AGENTE})=${EPOCH})
 same => n,Set(DB(taxi/corrida/base/${AGENTE})=${BASE})

 same => n,NoOp(CORRIDA INICIADA | motorista=${AGENTE} cliente=${CLIENTE} base=${BASE})

 ; ===== WEBHOOK =====
 same => n,Gosub(taxivaral-webhook-send,s,1(atendeu,${AGENTE},${CLIENTE},ANSWER,${BASE}))
 same => n,Return()

 same => n(skip_corrida),NoOp(SKIP REGISTRO DE CORRIDA | dados incompletos)
 same => n,Return()


[taxi-onanswer-errado]
exten => s,1,NoOp(ONANSWER | Motorista=${ARG1} | Cliente=${CALLERID(num)})
 same => n,Set(CLIENTE=${CALLERID(num)})
 same => n,Set(BASE=40)
 same => n,Set(AGENTE=${ARG1})

 ; nome do agente (usa seu mapeamento)
 same => n,Gosub(taxi-agent-name,s,1(${AGENTE}))

 same => n,Set(DATAHORA=${STRFTIME(${EPOCH},,%d/%m/%Y %H:%M:%S)})
 same => n,Set(MSG=${CLIENTE}\n${AGENTNAME}\nNa base sip: ${BASE}\nAgente sip: ${AGENTE}\n${DATAHORA})

 same => n,NoOp(ENVIANDO WEBHOOK (ONANSWER): ${MSG})
 same => n,Set(RES=${CURL(https://fabiomoto.duckdns.org/webhook/mototaxi,post,${MSG})})
 same => n,NoOp(RETORNO WEBHOOK (ONANSWER): ${RES})

 same => n,Return()

[taxi-webhook-send]
exten => s,1,NoOp(WEBHOOK SEND | RAW='${ARG1}')
 ; manda como form-urlencoded: content=<texto>
 same => n,Set(POSTDATA=content=${URIENCODE(${ARG1})})
 same => n,NoOp(POSTDATA=${POSTDATA})
 same => n,Set(RES=${CURL(https://fabiomoto.duckdns.org/webhook/taxivaral,${POSTDATA})})
 same => n,NoOp(WEBHOOK RES=${RES})
 same => n,Return()


; ======================================================
; TAXIVARAL WEBHOOK SEND (JSON)
; Chamada:
;   Gosub(taxivaral-webhook-send,s,1(evento,motorista,cliente,motivo,base))
;
; Ex:
;   Gosub(taxivaral-webhook-send,s,1(login,41,,,40))
;   Gosub(taxivaral-webhook-send,s,1(removido,41,,NOANSWER,50))
;   Gosub(taxivaral-webhook-send,s,1(atendeu,41,+5543999..., ,40))
; ======================================================

[taxivaral-webhook-send]
exten => s,1,NoOp(TAXIVARAL WEBHOOK SEND | evt=${ARG1} mot=${ARG2} cli=${ARG3} motivo=${ARG4} base=${ARG5})

 ; --------- Config do webhook ----------
 same => n,Set(WEBHOOK_URL=https://fabiomoto.duckdns.org/webhook/taxivaral)

 ; --------- Args ----------
 same => n,Set(EVT=${ARG1})
 same => n,Set(MOTORISTA=${ARG2})
 same => n,Set(CLIENTE=${ARG3})
 same => n,Set(MOTIVO=${ARG4})
 same => n,Set(BASE=${ARG5})

 ; --------- Defaults / limpeza ----------
 same => n,ExecIf($["${EVT}"=""]?Set(EVT=unknown))
 same => n,ExecIf($["${MOTORISTA}"=""]?Set(MOTORISTA=0))
 same => n,ExecIf($["${BASE}"=""]?Set(BASE=40))
 same => n,Set(CALLID=${UNIQUEID})

 ; --------- Data/hora ----------
 same => n,Set(TS=${EPOCH})
 same => n,Set(DATAHORA=${STRFTIME(${EPOCH},,%d/%m/%Y %H:%M:%S)})

 ; --------- Nome do motorista via AstDB ----------
 ; você cadastra assim:
 ;   database put taxi nome/41 Taxista_Antonio
 same => n,Set(MOTORISTA_NOME=${DB(taxi/nome/${MOTORISTA})})
 same => n,ExecIf($["${MOTORISTA_NOME}"=""]?Set(MOTORISTA_NOME=Motorista_${MOTORISTA}))

 ; --------- Monta JSON ----------
 ; Atenção: evita aspas dentro do nome. Use _ no lugar de espaço se quiser.
 same => n,Set(JSON={"ts":${TS},"datahora":"${DATAHORA}","event":"${EVT}","motorista_num":"${MOTORISTA}","motorista_nome":"${MOTORISTA_NOME}","base":"${BASE}","cliente":"${CLIENTE}","motivo":"${MOTIVO}","callid":"${CALLID}"} )

 same => n,NoOp(WEBHOOK JSON=${JSON})

 ; --------- Envia (curl) ----------
 ; -s  = silencioso
 ; -m  = timeout (não trava a chamada)
 same => n,System(/usr/bin/curl -s -m 3 -X POST -H "Content-Type: application/json" -d '${JSON}' "${WEBHOOK_URL}" >/dev/null 2>&1)

 same => n,Return()

; ======================================================
; MOTORISTA → CLIENTE (RECONEXÃO MANUAL)
; Discagem: *9
; Contexto: from-internal
; ======================================================

[taxi-driver-call-client]
exten => *9,1,NoOp(RECALL CLIENTE | MOTORISTA=${CALLERID(num)})

 ; normaliza motorista
 same => n,Set(MOTORISTA=${CALLERID(num)})
 same => n,Set(MOTORISTA=${FILTER(0-9,${MOTORISTA})})

 ; busca cliente da corrida ativa
 same => n,Set(CLIENTE=${DB(taxi/corrida/ativa/${MOTORISTA})})

 ; se não houver corrida ativa
 same => n,GotoIf($["${CLIENTE}"=""]?sem_corrida)

 ; chama cliente
 same => n,NoOp(CHAMANDO CLIENTE ${CLIENTE})
 same => n,Dial(PJSIP/${CLIENTE}@twilio-endpoint,30)

 same => n,Hangup()

 same => n(sem_corrida),Playback(beep)
 same => n,Playback(nobodyavail)
 same => n,Hangup()
