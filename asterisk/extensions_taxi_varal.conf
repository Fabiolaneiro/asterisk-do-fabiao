; ============================================================
; TAXI - VARAL DIGITAL (PASSO 1)
; Objetivo do passo 1:
; - Motorista faz "login" no varal digitando *41, *43 etc (no ramal 40)
; - Asterisk guarda uma lista FIFO no AstDB: DB(taxi/line)
; - Ter um código de status para checar a lista no CLI
; ============================================================

; ------------------------------------------------------------
; Contexto do telefone da base (ramal 40)
; Importante: o endpoint 40 aponta context=taxi-base
; ------------------------------------------------------------




; ------------------------------------------------------------
; SUBROTINA: adiciona agente no fim da lista FIFO (sem duplicar)
; Guarda em DB(taxi/line) no formato: 41|42|43
; ARG1 = agente (ex: 41)
; ------------------------------------------------------------
[taxi-varal-add]
exten => s,1,NoOp(ADD AGENTE=${ARG1})
 same => n,Set(AGENTE=${ARG1})
 same => n,Set(LISTA=${DB(taxi/line)})

 ; Se já existe, não adiciona
 same => n,Set(EXISTE=${REGEX("(^|\\|)${AGENTE}(\\||$)" ${LISTA})})
 same => n,GotoIf($[${EXISTE}=1]?done)

 ; Se lista vazia, vira só o agente
 same => n,GotoIf($["${LISTA}"=""]?first)

 ; Senão concatena no final
 same => n,Set(LISTA=${LISTA}|${AGENTE})
 same => n,Set(DB(taxi/line)=${LISTA})
 same => n,Goto(done)

 same => n(first),Set(DB(taxi/line)=${AGENTE})
 same => n(done),NoOp(NOVA LISTA = ${DB(taxi/line)})
 same => n,Return()



[taxi-varal-remove]
exten => s,1,NoOp(REMOVE AGENTE=${ARG1})
 same => n,Set(AGENTE=${ARG1})
 same => n,Set(LISTA=${DB(taxi/line)})
 same => n,NoOp(ANTES LISTA='${LISTA}' AGENTE='${AGENTE}')
 same => n,GotoIf($["${LISTA}"=""]?done)

 ; 1) protege com barras
 same => n,Set(WORK=|${LISTA}|)

 ; 2) remove exatamente |AGENTE|
 same => n,Set(WORK=${REPLACE(${WORK},|${AGENTE}|,|)})

 ; 3) normaliza barras duplicadas
 same => n,While($["${WORK}" != "${REPLACE(${WORK},||,|)}"])
  same => n,Set(WORK=${REPLACE(${WORK},||,|)})
 same => n,EndWhile()

 ; 4) remove barra do começo (se existir)
 same => n,ExecIf($["${WORK:0:1}"="|"]?Set(WORK=${WORK:1}))

 ; 5) remove barra do fim (usando LEN, sem índice negativo)
 same => n,Set(L=${LEN(${WORK})})
 same => n,ExecIf($[${L}>0 & "${WORK:$[${L}-1]:1}"="|"]?Set(WORK=${WORK:0:$[${L}-1]}))

 ; 6) grava
 same => n,Set(DB(taxi/line)=${WORK})
 same => n,NoOp(DEPOIS DB(taxi/line)='${DB(taxi/line)}')
 same => n(done),Return()


[taxi-base]

; LOGIN: *41 *42 *43 (no telefone da base/ramal 40)
exten => _*4[1-3],1,NoOp(TAXI LOGIN | Discado=${EXTEN})
 same => n,Set(AGENTE=${EXTEN:1})                   ; *41 -> 41
 same => n,Set(DB(taxi/present/${AGENTE})=${EPOCH}) ; salva hora de entrada
 same => n,Gosub(taxivaral-webhook-send,s,1(login,${AGENTE},,))
same => n,Playback(beep)
 same => n,Hangup()

; LOGOUT: #41 #42 #43 (continua do jeito que você já consegue discar)
exten => _#4[1-3],1,NoOp(TAXI LOGOUT | Discado=${EXTEN})
 same => n,Set(AGENTE=${EXTEN:1})                   ; #41 -> 41
 same => n,DBDeltree(taxi/present/${AGENTE})
; same => n,Gosub(taxivaral-webhook-send,s,1(login,${AGENTE},,))
; same => n,DBdel(taxi/present/${AGENTE})            ; remove SÓ esse
 same => n,Playback(beep)
 same => n,Hangup()

; STATUS: *940 mostra quem está logado e quem é "da vez"
exten => *940,1,NoOp(TAXI STATUS)
 same => n,Gosub(taxi-status,s,1)
 same => n,Playback(beep)
 same => n,Hangup()

[taxi-status]
exten => s,1,NoOp(--- TAXI STATUS ---)
 same => n,Set(T41=${DB(taxi/present/41)})
 same => n,Set(T42=${DB(taxi/present/42)})
 same => n,Set(T43=${DB(taxi/present/43)})
 same => n,NoOp(PRESENTES: 41=${T41} | 42=${T42} | 43=${T43})
 same => n,Gosub(taxi-pick,s,1)
 same => n,NoOp(DA VEZ = ${PICK} | TS=${PICKTS})
 same => n,Return()

[taxi-pickerrado]
exten => s,1,Set(PICK=)
 same => n,Set(PICKTS=)

 same => n,Set(T41=${DB(taxi/present/41)})
 same => n,Set(T42=${DB(taxi/present/42)})
 same => n,Set(T43=${DB(taxi/present/43)})

 ; escolhe o menor timestamp (mais antigo)
 same => n,ExecIf($["${T41}"!=""]?Set(PICK=41)&Set(PICKTS=${T41}))
 same => n,ExecIf($["${T42}"!=""]?ExecIf($["${PICK}"="" | ${T42} < ${PICKTS}]?Set(PICK=42)&Set(PICKTS=${T42})))
 same => n,ExecIf($["${T43}"!=""]?ExecIf($["${PICK}"="" | ${T43} < ${PICKTS}]?Set(PICK=43)&Set(PICKTS=${T43})))

 same => n,Return()

[taxi-pick]
exten => s,1,Set(PICK=)
 same => n,Set(PICKTS=)

 same => n,Set(T41=${DB(taxi/present/41)})
 same => n,Set(T42=${DB(taxi/present/42)})
 same => n,Set(T43=${DB(taxi/present/43)})

 ; se 41 existe, assume como candidato
 same => n,GotoIf($["${T41}"=""]?chk42)
 same => n,Set(PICK=41)
 same => n,Set(PICKTS=${T41})

 ; compara 42
 same => n(chk42),GotoIf($["${T42}"=""]?chk43)
 same => n,GotoIf($["${PICK}"=""]?set42)
 same => n,GotoIf($[${T42} < ${PICKTS}]?set42)
 same => n,Goto(chk43)
 same => n(set42),Set(PICK=42)
 same => n,Set(PICKTS=${T42})

 ; compara 43
 same => n(chk43),GotoIf($["${T43}"=""]?done)
 same => n,GotoIf($["${PICK}"=""]?set43)
 same => n,GotoIf($[${T43} < ${PICKTS}]?set43)
 same => n,Goto(done)
 same => n(set43),Set(PICK=43)
 same => n,Set(PICKTS=${T43})

 same => n(done),Return()




; ============================================================
; PASSO 2 - INBOUND DO TAXI (VARAL DIGITAL)
; ============================================================

[taxi-inbound]
exten => s,1,Gosub(taxi-varal-call,s,1)
 same => n,Hangup()

exten => _X.,1,Gosub(taxi-varal-call,s,1)
 same => n,Hangup()

exten => _+X.,1,Gosub(taxi-varal-call,s,1)
 same => n,Hangup()


; ============================================================
; SUBROTINA PRINCIPAL: chama ramal 40 usando a vez
; ============================================================
[taxi-varal-call-errado]
exten => s,1,NoOp(TAXI VARAL CALL START | CID=${CALLERID(num)} DID=${EXTEN})

 ; escolhe o motorista da vez (mais antigo)
 same => n,Gosub(taxi-pick,s,1)
 same => n,NoOp(DA VEZ=${PICK} TS=${PICKTS})

 ; se ninguém logado -> fallback
 same => n,GotoIf($["${PICK}"=""]?fallback)

 ; remove da vez ANTES de tocar (regra: atendeu ou não, sai)
 ; (mantém exatamente sua regra)
 same => n,DBDeltree(taxi/present/${PICK})

 ; toca o telefone da base por 30s
 same => n,NoOp(TOCANDO BASE 40 POR 30s | motorista_da_vez=${PICK})
 same => n,Dial(PJSIP/40,30)

 ; se atendeu, terminou (cliente falou com a base; já removemos o motorista)
 same => n,GotoIf($["${DIALSTATUS}"="ANSWER"]?done)

 ; não atendeu -> tenta próximo
 same => n,NoOp(NAO ATENDEU (${DIALSTATUS}) -> PROXIMO)
 same => n,Goto(s,2)

 same => n(fallback),NoOp(SEM MOTORISTAS LOGADOS -> FALLBACK FILA TAXI)
 same => n,Queue(uber,t)      ; <- você cria/usa uma fila "taxi" geral
 same => n,Return()

 same => n(done),NoOp(ATENDIDA NA BASE | motorista=${PICK})
 same => n,Return()

[taxi-varal-call]
exten => s,1,NoOp(TAXI VARAL CALL START | CID=${CALLERID(num)} DID=${EXTEN})
 same => n,Answer()
 same => n,Ringing()
 same => n(loop),Gosub(taxi-pick,s,1)
 same => n,NoOp(DA VEZ=${PICK} TS=${PICKTS})

 same => n,GotoIf($["${PICK}"=""]?fallback)

 ; remove da vez (atendeu ou não, sai)
 same => n,DBDeltree(taxi/present/${PICK})

 same => n,NoOp(TOCANDO BASE 40 POR 30s | motorista_da_vez=${PICK})
; same => n,Dial(PJSIP/40,30)
; same => n,Dial(PJSIP/40,30,U(taxi-onanswer^s^1(${PICK})))
 same => n,Dial(PJSIP/40,30,U(taxi-onanswer^s^1(${PICK},${CALLERID(num)})))


 same => n,NoOp(DIALSTATUS=${DIALSTATUS})
 same => n,GotoIf($["${DIALSTATUS}"="ANSWER"]?done)
;apartir daqui implementacao webhook
; ====== WEBHOOK (somente se atendeu) ======
;same => n,Set(CLIENTE=${CALLERID(num)})
;same => n,Set(BASE=40)
;same => n,Set(AGENTE=${PICK})

;same => n,Gosub(taxi-agent-name,s,1(${AGENTE}))

;same => n,Set(DATAHORA=${STRFTIME(${EPOCH},,%d/%m/%Y %H:%M:%S)})

;same => n,Set(MSG=${CLIENTE}\n${AGENTNAME}\nNa base sip: ${BASE}\nAgente sip: ${AGENTE}\n${DATAHORA})

;same => n,NoOp(ENVIANDO WEBHOOK: ${MSG})
;same => n,Set(RES=${CURL(https://fabiomoto.duckdns.org/webhook/taxivaral,post,${MSG})})
;same => n,NoOp(RETORNO WEBHOOK: ${RES})

;ate aqui implementacao do webhook


 same => n,NoOp(NAO ATENDEU (${DIALSTATUS}) -> PROXIMO)
same => n,Gosub(taxivaral-webhook-send,s,1(removido,${PICK},,${DIALSTATUS}))
;linha acima colocada para enviar webhook removido
 same => n,Goto(loop)

 same => n(fallback),NoOp(SEM MOTORISTAS LOGADOS -> FALLBACK FILA UBER)
 same => n,Queue(uber,t)
 same => n,Return()

 same => n(done),NoOp(ATENDIDA NA BASE | motorista=${PICK})
 same => n,Return()


[taxi-agent-name]
exten => s,1,Set(AGENTNUM=${ARG1})
 same => n,Set(AGENTNAME=Motorista ${AGENTNUM})
 same => n,ExecIf($["${AGENTNUM}"="41"]?Set(AGENTNAME=Taxista Antonio))
 same => n,ExecIf($["${AGENTNUM}"="42"]?Set(AGENTNAME=Taxista Bruno))
 same => n,ExecIf($["${AGENTNUM}"="43"]?Set(AGENTNAME=Taxista Carlos))
 same => n,Return()

[taxi-onanswer]
exten => s,1,NoOp(ONANSWER | AGENTE(ARG1)=${ARG1} | CLIENTE(ARG2)=${ARG2})

 same => n,Set(AGENTE=${ARG1})
 same => n,Set(CLIENTE=${ARG2})
 same => n,Set(BASE=40)

 ; se cliente veio vazio, tenta pegar do channel (fallback)
 same => n,ExecIf($["${CLIENTE}"=""]?Set(CLIENTE=${CALLERID(num)}))

 ; nome do agente
 same => n,Gosub(taxi-agent-name,s,1(${AGENTE}))

 same => n,Set(DATAHORA=${STRFTIME(${EPOCH},,%d/%m/%Y %H:%M:%S)})

 ; mensagem no seu padrão
 same => n,Set(CONTENT=${CLIENTE}\n${AGENTNAME}\nNa base : ${BASE}\nAgente: ${AGENTE}\n${DATAHORA})

 ; envia em JSON
 same => n,Gosub(taxi-webhook-send,s,1(${CONTENT}))

 same => n,Return()


[taxi-onanswer-errado]
exten => s,1,NoOp(ONANSWER | Motorista=${ARG1} | Cliente=${CALLERID(num)})
 same => n,Set(CLIENTE=${CALLERID(num)})
 same => n,Set(BASE=40)
 same => n,Set(AGENTE=${ARG1})

 ; nome do agente (usa seu mapeamento)
 same => n,Gosub(taxi-agent-name,s,1(${AGENTE}))

 same => n,Set(DATAHORA=${STRFTIME(${EPOCH},,%d/%m/%Y %H:%M:%S)})
 same => n,Set(MSG=${CLIENTE}\n${AGENTNAME}\nNa base sip: ${BASE}\nAgente sip: ${AGENTE}\n${DATAHORA})

 same => n,NoOp(ENVIANDO WEBHOOK (ONANSWER): ${MSG})
 same => n,Set(RES=${CURL(https://fabiomoto.duckdns.org/webhook/mototaxi,post,${MSG})})
 same => n,NoOp(RETORNO WEBHOOK (ONANSWER): ${RES})

 same => n,Return()

[taxi-webhook-send]
exten => s,1,NoOp(WEBHOOK SEND | RAW='${ARG1}')
 ; manda como form-urlencoded: content=<texto>
 same => n,Set(POSTDATA=content=${URIENCODE(${ARG1})})
 same => n,NoOp(POSTDATA=${POSTDATA})
 same => n,Set(RES=${CURL(https://fabiomoto.duckdns.org/webhook/taxivaral,${POSTDATA})})
 same => n,NoOp(WEBHOOK RES=${RES})
 same => n,Return()


[taxivaral-webhook-send]
exten => s,1,NoOp(TAXIVARAL WEBHOOK SEND | event=${ARG1} motorista=${ARG2} cliente=${ARG3} motivo=${ARG4})

 ; Args
 same => n,Set(EVT=${ARG1})
 same => n,Set(MOTORISTA=${ARG2})
 same => n,Set(CLIENTE=${ARG3})
 same => n,Set(MOTIVO=${ARG4})

 ; Campos padrao
 same => n,Set(TS=${EPOCH})
 same => n,Set(DATAHORA=${STRFTIME(${EPOCH},,%d/%m/%Y %H:%M:%S)})
 same => n,Set(BASE=40)
 same => n,Set(CALLID=${UNIQUEID})

 ; Nome do motorista (usa seu mapeamento existente)
 same => n,Gosub(taxi-agent-name,s,1(${MOTORISTA}))

 ; Monta POST form-urlencoded com campos separados
 same => n,Set(POSTDATA=event=${URIENCODE(${EVT})})
 same => n,Set(POSTDATA=${POSTDATA}&ts=${TS})
 same => n,Set(POSTDATA=${POSTDATA}&datahora=${URIENCODE(${DATAHORA})})
 same => n,Set(POSTDATA=${POSTDATA}&motorista_num=${URIENCODE(${MOTORISTA})})
 same => n,Set(POSTDATA=${POSTDATA}&motorista_nome=${URIENCODE(${AGENTNAME})})
 same => n,Set(POSTDATA=${POSTDATA}&base=${URIENCODE(${BASE})})
 same => n,Set(POSTDATA=${POSTDATA}&callid=${URIENCODE(${CALLID})})

 ; opcionais
 same => n,ExecIf($["${CLIENTE}"!=""]?Set(POSTDATA=${POSTDATA}&cliente=${URIENCODE(${CLIENTE})}))
 same => n,ExecIf($["${MOTIVO}"!=""]?Set(POSTDATA=${POSTDATA}&motivo=${URIENCODE(${MOTIVO})}))

 same => n,NoOp(POSTDATA=${POSTDATA})

 ; Envia
 same => n,Set(RES=${CURL(https://fabiomoto.duckdns.org/webhook/taxivaral,${POSTDATA})})
 same => n,NoOp(WEBHOOK RES=${RES})
 same => n,Return()



